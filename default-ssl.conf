<VirtualHost *:443>
	ServerName meterlogger.net

	ServerAdmin stoffer@skulp.net
	DocumentRoot /var/www/nabovarme

	# Available loglevels: trace8, ..., trace1, debug, info, notice, warn,
	# error, crit, alert, emerg.
	# It is also possible to configure the loglevel for particular
	# modules, e.g.
	#LogLevel info ssl:warn

	ErrorLog ${APACHE_LOG_DIR}/error.log
	CustomLog ${APACHE_LOG_DIR}/access.log combined

	SSLEngine On
	SSLCertificateFile /etc/letsencrypt/live/meterlogger.net/cert.pem
	SSLCertificateKeyFile /etc/letsencrypt/live/meterlogger.net/privkey.pem
	SSLCertificateChainFile /etc/letsencrypt/live/meterlogger.net/chain.pem

#	Header always set Strict-Transport-Security "max-age=15768000"

#	RequestHeader append "X-Forwarded-Proto" "https"
#	RequestHeader set "X-Forwarded-Ssl" "on"
	DirectoryIndex index.epl index.html

	PerlRequire /etc/apache2/perl/startup.pl
	PerlModule Apache2::Reload
	PerlInitHandler Apache2::Reload

	<Location /data>
		SetHandler perl-script
		PerlResponseHandler Nabovarme::Data
		SetOutputFilter DEFLATE
	</Location>
	<Location /network_data>
		SetHandler perl-script
		PerlResponseHandler Nabovarme::NetworkData
		SetOutputFilter DEFLATE
	</Location>
	<Location /sms_spool>
		Order allow,deny
		Deny from all
	</Location>

	<Location />
		SetHandler perl-script
		PerlFixupHandler Nabovarme::Redirect

		PerlSetVar DefaultPath		'/'
		PerlSetVar LoginPath		'/private/login.epl'
		PerlSetVar LoggedOutPath	'/logged_out.epl'
		PerlSetVar SMSCodePath		'/private/sms_code.epl'
		PerlSetVar DefaultStayLoggedIn	'true'
		PerlAccessHandler Nabovarme::SMSAuth
	</Location>

#	<Location /private>
#		PerlSetVar LoginPath		'/private/login.epl'
#		PerlSetVar LoggedOutPath	'/logged_out.epl'
#		PerlSetVar SMSCodePath		'/private/sms_code.epl'
#		PerlSetVar DefaultStayLoggedIn	'true'
#		PerlAccessHandler Nabovarme::SMSAuth
#	</Location>

	PerlSetEnv EMBPERL_DEBUG 2285
	PerlSetEnv EMBPERL_ESCMODE 0
	PerlSetEnv EMBPERL_OPTIONS	262144
</VirtualHost>


SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
SSLCipherSuite ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS
SSLHonorCipherOrder on
SSLCompression off
#SSLSessionTickets off

SSLUseStapling on
SSLStaplingResponderTimeout 5
SSLStaplingReturnResponderErrors off
SSLStaplingCache shmcb:/var/run/ocsp(128000)

# vim: syntax=apache ts=4 sw=4 sts=4 sr noet

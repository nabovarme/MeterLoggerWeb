<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="robots" content="noindex" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Meterlogger alarms overview</title>

	<link rel="stylesheet" href="/menu.css" />
	<script src="/js/menu.js" defer></script>
	<link rel="stylesheet" href="/alarms.css" />
</head>
<body>

<!-- Floating Search UI -->
<div id="alarmSearchContainer">
	<input
		type="search"
		id="alarmFilter"
		placeholder="Search alarms..."
		style="font-size: 1.2em; padding: 10px; width: 100%; max-width: 400px; box-sizing: border-box;"
	/>
	<label style="user-select:none; font-size: 1em; display: flex; align-items: center; gap: 5px;">
		<input type="checkbox" id="alarmSearch" />
		Active alarms
	</label>
</div>

<!-- Dynamic alarm content -->
<div id="alarmContainer"></div>
<div style="height: 100px;"></div>

<script>
async function fetchAndRenderAlarms() {
	const container = document.getElementById('alarmContainer');
	container.innerHTML = '';

	const response = await fetch('/api/alarms');
	const data = await response.json();

	data.forEach(group => {
		const groupDiv = document.createElement('div');
		groupDiv.className = 'alarm-group';
		groupDiv.textContent = group.group_name;
		container.appendChild(groupDiv);

		let lastSerial = '';
		group.alarms.forEach((alarm, i) => {
			const isNewSerial = alarm.serial !== lastSerial;
			if (isNewSerial) {
				const infoDiv = document.createElement('div');
				infoDiv.className = 'alarm-info';
				infoDiv.innerHTML = `<a href="detail.epl?serial=${alarm.serial}">${alarm.serial}</a> ${alarm.info || ''}`;
				container.appendChild(infoDiv);

				const columnsDiv = document.createElement('div');
				columnsDiv.className = 'alarm-columns';
				columnsDiv.innerHTML = `
					<div>ID</div>
					<div>Alarm receiver</div>
					<div>Condition</div>
					<div>Repeating</div>
					<div>Snoozed</div>
					<div>Comment</div>
				`;
				container.appendChild(columnsDiv);
				lastSerial = alarm.serial;
			}

			const rowDiv = document.createElement('div');
			rowDiv.className = 'alarm-row';
			if (alarm.alarm_state && alarm.enabled) rowDiv.classList.add('alarm-active');
			if (!alarm.enabled) rowDiv.classList.add('alarm-disabled');

			const repeat = alarm.repeat ? `every ${alarm.repeat}` : 'no';
			const snooze = alarm.snooze ? alarm.snooze : 'no';

			rowDiv.innerHTML = `
				<div><a href="alarms_detail.epl?id=${alarm.id}">${alarm.id || ''}</a></div>
				<div>${alarm.sms_notification || ''}</div>
				<div>${alarm.condition_error ? '<strong style="color:red">' : ''}${alarm.condition || ''}${alarm.condition_error ? '</strong>' : ''}</div>
				<div>${repeat}</div>
				<div>${snooze}</div>
				<div>${alarm.comment || ''}</div>
			`;

			container.appendChild(rowDiv);
		});
	});
}

document.addEventListener('DOMContentLoaded', fetchAndRenderAlarms);
</script>
<script src="/js/search_alarms.js" defer></script>
</body>
</html>

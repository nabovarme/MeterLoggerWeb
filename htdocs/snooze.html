<!DOCTYPE html>
<html lang="en">
<head>
	<meta name="robots" content="noindex">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MeterLogger Snooze Alarm</title>

	<style>
		body {
			font-family: Verdana, Geneva, sans-serif;
			padding: 16px;
			margin: 0;
			background: #fff;
		}

		#status {
			margin-bottom: 16px;
			font-weight: bold;
			font-size: 1rem;
			min-height: 2.5em;
		}

		/* Hide slider initially until first fetch */
		label {
			display: none;
			margin-top: 24px;
			font-size: 1rem;
		}

		#durationDisplay {
			display: block;
			font-weight: bold;
			font-size: 1.3rem;
			margin: 8px 0 12px;
		}

		input[type=range] {
			width: 100%;
			height: 44px; /* touch-friendly */
			margin: 8px 0;
			box-sizing: border-box;
		}

		/* WebKit (iOS / Chrome) */
		input[type=range]::-webkit-slider-thumb {
			-webkit-appearance: none;
			height: 28px;
			width: 28px;
			border-radius: 50%;
			background: #007aff;
			cursor: pointer;
		}

		/* Firefox */
		input[type=range]::-moz-range-thumb {
			height: 28px;
			width: 28px;
			border-radius: 50%;
			background: #007aff;
			cursor: pointer;
		}

		/* Dim slider when using default value */
		.default-state input[type=range] {
			opacity: 0.6;
		}

		/* Center content on larger screens */
		@media (min-width: 600px) {
			body {
				max-width: 500px;
				margin: auto;
			}
		}
	</style>

	<script>
		let snoozeIsDefault = false; // track if the slider is showing default value
		let minSnoozeSec = 60;       // dynamic minimum based on API repeat value

		// Read auth token from raw query string (?<auth>)
		function getAuthFromQuery() {
			const qs = window.location.search;
			if (!qs || qs.length < 2) return null;
			return qs.substring(1);
		}

		// Human-readable duration (mirrors Perl human_duration)
		function humanDuration(seconds) {
			if (seconds === undefined || seconds === null) return '';

			let value, unit;

			if (seconds < 60) {
				value = seconds;
				unit = 'second';
			} else if (seconds < 3600) {
				value = Math.floor(seconds / 60);
				unit = 'minute';
			} else if (seconds < 86400) {
				value = Math.floor(seconds / 3600);
				unit = 'hour';
			} else if (seconds < 604800) {
				value = Math.floor(seconds / 86400);
				unit = 'day';
			} else if (seconds < 2678400) {
				value = Math.floor(seconds / 604800);
				unit = 'week';
			} else {
				value = Math.floor(seconds / 2678400);
				unit = 'month';
			}

			if (value !== 1) unit += 's';
			return `${value} ${unit}`;
		}

		// Snap seconds to nearest display unit
		function snapToFormatted(seconds) {
			if (seconds < 3600) return Math.round(seconds / 60) * 60;
			if (seconds < 86400) return Math.round(seconds / 3600) * 3600;
			if (seconds < 604800) return Math.round(seconds / 86400) * 86400;
			if (seconds < 2678400) return Math.round(seconds / 604800) * 604800;
			if (seconds < 31536000) return Math.round(seconds / 2678400) * 2678400;
			return Math.round(seconds / 31536000) * 31536000;
		}

		// Slider ↔ seconds conversion
		function sliderToSeconds(value) {
			const maxSec = 31536000;
			const scale = value / 100;
			return Math.round(minSnoozeSec * Math.pow(maxSec / minSnoozeSec, scale));
		}

		function secondsToSlider(seconds) {
			if (seconds <= minSnoozeSec) return 0;
			const maxSec = 31536000;
			return Math.log(seconds / minSnoozeSec) / Math.log(maxSec / minSnoozeSec) * 100;
		}

		// Fetch current snooze
		async function fetchCurrentSnooze(auth) {
			const url = '/api/snooze/' + encodeURIComponent(auth);
			try {
				const res = await fetch(url);
				const data = await res.json();

				if (data.authorized && data.alarm && typeof data.alarm.snooze === 'number') {
					// Use repeat value as minimum snooze
					if (typeof data.alarm.repeat === 'number' && data.alarm.repeat > 0) {
						minSnoozeSec = data.alarm.repeat;
					}

					let snooze = data.alarm.snooze;
					if (snooze === 0 && typeof data.alarm.default_snooze === 'number') {
						snooze = data.alarm.default_snooze;
						snoozeIsDefault = true; // indicate default
					} else {
						snoozeIsDefault = false;
					}

					if (snooze < minSnoozeSec) snooze = minSnoozeSec;
					return snapToFormatted(snooze);
				}

				document.getElementById('status').textContent = data.error || "Not found";
				return null;
			} catch (err) {
				console.error(err);
				document.getElementById('status').textContent = "Error contacting server";
				return null;
			}
		}

		// Update snooze
		function snoozeAlarm(auth, snooze) {
			if (!auth) {
				document.getElementById('status').textContent = "Missing auth key";
				return;
			}

			const url = '/api/snooze/' + encodeURIComponent(auth) + '/' + encodeURIComponent(snooze);
			fetch(url)
				.then(res => res.json())
				.then(data => {
					const container = document.getElementById('status');
					if (data.authorized) {
						container.textContent =
							"Alarm snoozed for " + (data.alarm.snooze_human || humanDuration(snooze)) + ".";
					} else {
						container.textContent = data.error || "Not found";
					}
				})
				.catch(err => {
					console.error(err);
					document.getElementById('status').textContent = "Error contacting server";
				});
		}

		// Slider release handler
		function onSliderChange() {
			const auth = getAuthFromQuery();
			const slider = document.getElementById('snoozeSlider');
			let seconds = sliderToSeconds(parseInt(slider.value, 10));
			seconds = snapToFormatted(seconds);

			document.getElementById('durationDisplay').textContent = humanDuration(seconds);
			snoozeAlarm(auth, seconds);
			slider.value = secondsToSlider(seconds);

			// Remove default state after user interacts
			if (snoozeIsDefault) {
				snoozeIsDefault = false;
				slider.parentElement.classList.remove('default-state');
			}

			// Light vibration feedback (mobile)
			if (navigator.vibrate) navigator.vibrate(20);
		}

		// Init
		window.addEventListener('DOMContentLoaded', async () => {
			const auth = getAuthFromQuery();
			if (!auth) {
				document.getElementById('status').textContent = "Missing auth key";
				return;
			}

			const currentSnooze = await fetchCurrentSnooze(auth);
			if (currentSnooze === null) return;

			const slider = document.getElementById('snoozeSlider');
			const label = slider.parentElement;

			// Show "(default)" only on initial load if using default snooze
			if (snoozeIsDefault) {
				label.classList.add('default-state');
				document.getElementById('durationDisplay').textContent =
					humanDuration(currentSnooze) + " (default)";
			} else {
				document.getElementById('durationDisplay').textContent = humanDuration(currentSnooze);
			}

			slider.value = secondsToSlider(currentSnooze);
			label.style.display = "block";

			slider.addEventListener('input', () => {
				let seconds = sliderToSeconds(parseInt(slider.value, 10));
				seconds = snapToFormatted(seconds);
				// Always just show human-readable duration while sliding
				document.getElementById('durationDisplay').textContent = humanDuration(seconds);
			});

			slider.addEventListener('change', onSliderChange);
		});
	</script>
</head>

<body>
	<div id="status"></div>

	<label>
		Snooze Duration
		<span id="durationDisplay"></span>
		<input type="range" id="snoozeSlider" min="0" max="100" step="1">
	</label>
</body>
</html>

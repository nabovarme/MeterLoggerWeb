<!DOCTYPE html>
<html lang="en">
<head>
	<meta name="robots" content="noindex">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>MeterLogger Snooze Alarm</title>
	<style>
		body {
			font-family: Verdana, Geneva, sans-serif;
			padding: 20px;
		}
		#status {
			margin-bottom: 20px;
			font-weight: bold;
		}
		/* Hide slider initially until first fetch */
		label {
			display: none;
			margin-top: 20px;
		}
		input[type=range] {
			width: 100%;
			max-width: 100%;
			box-sizing: border-box;
		}
		#durationDisplay {
			font-weight: bold;
			margin-left: 10px;
		}
	</style>
	<script>
		// Read auth token from raw query string (?<auth>)
		function getAuthFromQuery() {
			const qs = window.location.search;
			if (!qs || qs.length < 2) {
				return null;
			}
			return qs.substring(1); // strip leading '?'
		}

		// Format seconds to human-readable, whole numbers only
		function formatDuration(seconds) {
			if (seconds < 3600) {
				return Math.round(seconds / 60) + " min";
			} else if (seconds < 86400) {
				return Math.floor(seconds / 3600) + " hr";
			} else if (seconds < 604800) {
				return Math.floor(seconds / 86400) + " day";
			} else if (seconds < 2678400) {
				return Math.floor(seconds / 604800) + " week";
			} else if (seconds < 31536000) {
				return Math.floor(seconds / 2678400) + " month";
			} else {
				return Math.floor(seconds / 31536000) + " yr";
			}
		}

		// Convert slider value (0-100) to seconds using non-linear scale
		function sliderToSeconds(value) {
			const minSec = 60;			// 1 min
			const maxSec = 31536000;	// 1 yr
			const scale = value / 100;
			return Math.round(minSec * Math.pow(maxSec / minSec, scale));
		}

		// Convert seconds to slider value (inverse of sliderToSeconds)
		function secondsToSlider(seconds) {
			// If snooze is 0, map to 0 (leftmost slider position)
			if (seconds <= 0) return 0;

			const minSec = 60;       // 1 min
			const maxSec = 31536000; // 1 yr
			return Math.log(seconds / minSec) / Math.log(maxSec / minSec) * 100;
		}

		// Fetch current snooze without updating
		async function fetchCurrentSnooze(auth) {
			const url = '/api/snooze/' + encodeURIComponent(auth); // no snooze appended
			try {
				const res = await fetch(url);
				const data = await res.json();
				if (
					data.authorized &&
					data.alarm &&
					typeof data.alarm.snooze === 'number'
				) {
					return data.alarm.snooze; // seconds (can be 0)
				} else {
					document.getElementById('status').textContent = data.error || "Not found";
					return 300; // default 5 min
				}
			} catch (err) {
				console.error(err);
				document.getElementById('status').textContent = "Error contacting server";
				return 300;
			}
		}

		// Call API to update snooze alarm
		function snoozeAlarm(auth, snooze) {
			if (!auth) {
				document.getElementById('status').textContent = "Missing auth key";
				return;
			}

			let url = '/api/snooze/' + encodeURIComponent(auth) + '/' + encodeURIComponent(snooze);

			fetch(url)
				.then(res => res.json())
				.then(data => {
					const container = document.getElementById('status');
					if (data.authorized) {
						container.textContent = "Alarm snoozed for " + (data.alarm.snooze_human || formatDuration(snooze)) + ".";
					} else {
						container.textContent = data.error || "Not found";
					}
				})
				.catch(err => {
					console.error(err);
					document.getElementById('status').textContent = "Error contacting server";
				});
		}

		// Triggered when slider changes
		function onSliderChange() {
			const auth = getAuthFromQuery();
			const slider = document.getElementById('snoozeSlider');
			const seconds = sliderToSeconds(parseInt(slider.value, 10));
			document.getElementById('durationDisplay').textContent = formatDuration(seconds);
			snoozeAlarm(auth, seconds);
		}

		window.addEventListener('DOMContentLoaded', async () => {
			const auth = getAuthFromQuery();
			if (!auth) {
				document.getElementById('status').textContent = "Missing auth key";
				return;
			}

			// Fetch current snooze without updating
			const currentSnooze = await fetchCurrentSnooze(auth);

			// Initialize slider
			const slider = document.getElementById('snoozeSlider');
			const label = slider.parentElement; // reference to the <label>
			slider.value = secondsToSlider(currentSnooze);
			document.getElementById('durationDisplay').textContent = formatDuration(currentSnooze);

			// Show slider after fetch
			label.style.display = "block";

			// Update label live while dragging
			slider.addEventListener('input', () => {
				const seconds = sliderToSeconds(parseInt(slider.value, 10));
				document.getElementById('durationDisplay').textContent = formatDuration(seconds);
			});

			// Only call API when slider is released
			slider.addEventListener('change', onSliderChange);
		});
	</script>
</head>
<body>

<div id="status"></div>

<label>
	Snooze Duration: <span id="durationDisplay"></span>
	<input type="range" id="snoozeSlider" min="0" max="100" step="1">
</label>

</body>
</html>

<HTML>
[- 
	use Time::Format qw( time_format );

	use lib qw( /var/www/lib/perl );
	use Nabovarme::Db;
	use Nabovarme::Admin;
	use Nabovarme::Utils;

	$admin = new Nabovarme::Admin;
	$is_admin = $admin->cookie_is_admin($req_rec, $fdat{'serial'});

	if ($is_admin && ($fdat{add_state} =~ /add/i)) {
		$admin->add_payment($fdat{serial}, $fdat{type}, $fdat{unix_time}, $fdat{info}, $fdat{amount}, $fdat{price});
		$http_headers_out{'Location'} = "detail_acc.epl?serial=" . $fdat{serial};
	}

	if ($dbh = Nabovarme::Db->my_connect) {
		my $quoted_serial = $dbh->quote($fdat{'serial'});
		$meter_info_sth = $dbh->prepare(qq[SELECT `info` FROM meters WHERE `serial` like $quoted_serial]);
		$meter_info_sth->execute;

		$latest_sample_sth = $dbh->prepare(qq[SELECT hours, volume, energy FROM samples_cache WHERE serial LIKE $quoted_serial ORDER BY `unix_time` DESC LIMIT 1]);
		$latest_sample_sth->execute;

	if ($meter_info_sth->rows) {
		if ($d = $meter_info_sth->fetchrow_hashref) {
			$info = $d->{info};
		}
	}
	}
-] 
	<HEAD>
		<meta name="robots" content="noindex">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<TITLE>[+ $info +] MeterLogger</TITLE>
		<script type="text/javascript">
			var meter_serial = "[+ $fdat{'serial'} +]"
		</script>

		<!-- style and js for burger menu -->
		<link rel="stylesheet" href="/css/menu.css">
		<script src="/js/menu.js" defer></script>	

		<script src="/js/dygraph.min.js"></script>
		<link rel="stylesheet" href="/css/dygraph.css">

		<link rel="stylesheet" href="/css/detail_acc.css">
	</HEAD>
	<BODY>
		<span class="default-bold">
			[+ $info +]
		</span>
		<span class="default">
			<a href="detail.epl?serial=[+ $fdat{'serial'} +]">Details</a>
		</span>
		<span class="default-small">
			<a href="/qr/[+ $fdat{'serial'} +]">QR</a>
			[$ if ($is_admin) $] <a href="update_wifi.epl?serial=[+ $fdat{'serial'} +]">Update wifi</a>[$ endif $]
		</span>
		<br>
		<span class="default">
			serial [+ $fdat{'serial'} +]<br>
			<div id="last_energy"></div>
		</span>
		
		<div id="div_dygraph"></div>
		<div id="consumption_in_range"></div>
		<div id="payments_table" align="left" valign="bottom"></div>
		[$ if ($is_admin) $]
		<div id="add_payment"></div>
		[$ endif $]
		<div id="kwh_left"></div>

		<script src="detail_acc.js"></script>
	</BODY>
</HTML>

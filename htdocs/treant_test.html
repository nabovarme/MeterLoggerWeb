<!DOCTYPE html>
<html>
<head>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/treant-js/1.0/Treant.min.js"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/treant-js/1.0/Treant.css" />
	<style>
		.chart-container { width: 600px; height: 400px; margin-bottom: 40px; border: 1px solid #ccc; }
	</style>
</head>
<body>

<div id="trees">Loading tree data...</div>

<script>
	// Recursive function to create Treant nodes for clients and nested clients
	function createClientNode(client) {
		const meter = client.meter || {};
		const name = meter.info ? `${meter.info} (Serial: ${meter.serial || 'N/A'})` : "Client";

		let children = [];
		if (client.clients && client.clients.length) {
			children = client.clients.map(createClientNode);
		}

		return {
			text: { name },
			children: children
		};
	}

	// Convert each router object into Treant config
	function createTreeConfig(routerObj, index) {
		const routerName = routerObj.router?.name || "Router";

		// Root node is the router
		const rootNode = {
			text: { name: `Router: ${routerName}` },
			children: []
		};

		// Add top-level clients recursively
		if (routerObj.clients && routerObj.clients.length) {
			rootNode.children = routerObj.clients.map(createClientNode);
		}

		return {
			chart: { container: `#tree${index}` },
			nodeStructure: rootNode
		};
	}

	async function fetchAndRenderTrees() {
		try {
			const response = await fetch('/api/meters/tree');
			if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

			const data = await response.json();

			const container = document.getElementById('trees');
			container.innerHTML = '';	// clear loading text

			data.forEach((routerObj, i) => {
				// Create div for each tree
				const treeDiv = document.createElement('div');
				treeDiv.id = `tree${i}`;
				treeDiv.className = 'chart-container';
				container.appendChild(treeDiv);

				// Create Treant config
				const config = createTreeConfig(routerObj, i);

				// Render tree
				new Treant(config);
			});

		} catch (err) {
			document.getElementById('trees').innerText = 'Failed to load tree data: ' + err.message;
			console.error(err);
		}
	}

	fetchAndRenderTrees();
</script>

</body>
</html>
